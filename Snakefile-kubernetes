
shell.prefix("set -eo pipefail; ")

configfile: "config_ACC_NeuN+_H3K4me3.yaml"
localrules: all

ALL_SAMPLES = config["ips"] + config["controls"]


#ALL_SAMPLES = ["HBCC_ACC_340_A"] 
ALL_SAM = expand("mapped_reads/{sample}.raw.sam.gz", sample = ALL_SAMPLES)

rule all:
	input: ALL_SAM

rule bwa:
	input: 
		input1 = "samples/{sample}.R1.fastq.gz",
		input2 = "samples/{sample}.R2.fastq.gz",
		index  = "shared/hg19_with_sponges.tar.gz"
	output:
		"mapped_reads/{sample}.raw.sam.gz"
	threads: 32
	singularity:
		"docker://polumechanos/psychencode:bwa"
	message: "Map to the genome"
	shell:
		"tar xvzf {input.index};"
		"bwa mem -M -t {threads} ./hg19_with_sponges.fa {input.input1} {input.input2} | gzip -c > {output}"

